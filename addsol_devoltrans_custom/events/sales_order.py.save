import frappe


# After Insert
def after_insert(doc, event):

    if doc.doctype != "Sales Order":
        return

    # -----------------------------
    # 1. Append Project ID to Sales Order name
    # -----------------------------
    project = doc.project

    if not project:
        return  # should not happen, because mandatory

    # Fetch project document
    project = frappe.get_doc("Project", doc.project)

    # project.id or project.name ?
    # Using project.name because this is the actual ID generated by naming series.
    project_id = project.name

    # Already renamed?
    if project_id in doc.name:
        return

    # new name format â†’ SO-####-<ProjectID>
    new_name = f"{project_id}: {doc.name}"

    # if name already matches pattern, skip
    if new_name == doc.name:
        return

    # rename Sales Order safely
    frappe.rename_doc(
        doctype="Sales Order",
        old=doc.name,
        new=new_name,
        force=True,
        merge=False
    )

    # update in-memory instance
    doc.name = new_name

    # -----------------------------
    # 2. Link Sales Order back to Project
    # -----------------------------
    project = frappe.get_doc("Project", project_id)

    updated = False

    # Set Sales Order reference on Project (optional field â€” use custom field or default field)
    # If you already have a field: 'sales_order'
    if hasattr(project, "sales_order"):
        if not project.sales_order:
            project.sales_order = doc.name
            updated = True
    else:
        # If field doesn't exist, add a comment instead so link still exists
        if not frappe.db.exists("Communication", {"reference_doctype": "Project", "reference_name": project_id, "subject": doc.name}):
            project.add_comment("Info", f"Linked Sales Order: {doc.name}")

    # -----------------------------
    # 3. Link Customer to Project (if not already linked)
    # -----------------------------
    # Project usually has a field called 'customer' (ERPNext Standard)
    if hasattr(project, "customer"):
        if not project.customer:
            project.customer = doc.customer
            updated = True

    # -----------------------------
    # 4. Save only if fields were updated
    # -----------------------------
    if updated:
        project.save(ignore_permissions=True)


# # Add boolean field
# def create_custom_auto_generate_project_field():
#     """Add 'Auto Generate Project' checkbox to Sales Order"""
#     if not frappe.db.exists("Custom Field", {"dt": "Sales Order", "fieldname": "custom_auto_generate_project"}):
#         frappe.get_doc({
#             "doctype": "Custom Field",
#             "dt": "Sales Order",
#             "fieldname": "custom_auto_generate_project",
#             "label": "Auto Generate Project",
#             "fieldtype": "Check",
#             "insert_after": "customer",  # adjust position as needed
#             "default": 1,
#             "module": "Selling",
#         }).insert(ignore_permissions=True)
#         frappe.clear_cache(doctype="Sales Order")
#       })

#         # Bypass ALL validate hooks (safe for auto-creation)
#         # project.flags.ignore_validate = True
#         project.insert(ignore_permissions=True)

#         # Rename project to be more descriptive
#         new_name = f"{project.name} : {doc.customer_name} : {doc.name}"
#         project.db_set("project_name", new_name)

#         # Link back to Sales Order
#         doc.db_set("project", project.name)

#         frappe.msgprint(
#             f"Project <b>{project.name}</b> created for Sales Order <b>{doc.name}</b>", indicator="green")



# # on Sales Order Submit create a peoject
# def on_submit(doc, method):
#     # If Auto generation flag is set
#     if doc.custom_auto_generate_project and not doc.project:
#         project = frappe.get_doc({
#             "doctype": "Project",
#             "project_name": f"Project for {doc.name} - {doc.customer_name}",
#             "customer": doc.customer,
#             "sales_order": doc.name,
#             "expected_start_date": doc.transaction_date,
#             "expected_end_date": doc.delivery_date,
#             "status": "Open"
#         })

#         # Bypass ALL validate hooks (safe for auto-creation)
#         # project.flags.ignore_validate = True
#         project.insert(ignore_permissions=True)

#         # Rename project to be more descriptive
#         new_name = f"{project.name} : {doc.customer_name} : {doc.name}"
#         project.db_set("project_name", new_name)

#         # Link back to Sales Order
#         doc.db_set("project", project.name)

#         frappe.msgprint(
#             f"Project <b>{project.name}</b> created for Sales Order <b>{doc.name}</b>", indicator="green")


def on_submit_sales_order(doc, method):
    # ------- Prepare message --------
    project_code = doc.project or "Not Assigned"
    delivery_date = doc.delivery_date or "Not Set"

    # HTML email template
    message = f"""
    <div style="font-family: Arial, sans-serif; max-width: 650px; margin: 0 auto;
        border: 1px solid #e5e5e5; border-radius: 8px; background: #ffffff;">

        <div style="background: #e81a1a; padding: 16px; border-radius: 8px 8px 0 0;">
            <h2 style="margin: 0; color: #ffffff; font-size: 20px;">
                ðŸ“„ New Sales Order Received
            </h2>
        </div>

        <div style="padding: 20px; font-size: 14px; color: #333333;">
            <p style="font-size: 15px; margin-bottom: 20px;">
                Hello Team,<br>
                We have received a <b>new order</b>. Please find the attached document for more information.
            </p>

            <div style="background: #f9f9f9; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                <p style="margin: 6px 0;"><b>Sales Order:</b> {doc.name}</p>
                <p style="margin: 6px 0;"><b>Customer:</b> {doc.customer_name}</p>
                <p style="margin: 6px 0;"><b>Project:</b> {project_code}</p>
                <p style="margin: 6px 0;"><b>Delivery Date:</b> {delivery_date}</p>
            </div>

            <p style="margin-top: 15px; font-size: 14px;">
                Please take necessary action.
            </p>
        </div>

        <div style="background: #e81a1a; padding: 10px; border-radius: 0 0 8px 8px; text-align:center;">
            <p style="color: #ffffff; margin: 0; font-size: 13px;">ERPNext Auto Notification</p>
        </div>
    </div>
    """

    # ------- Generate PDF from print format --------
    pdf_dict = frappe.attach_print(
        doctype="Sales Order",
        name=doc.name,
        print_format="Sales Order Without Price"
    )
    pdf_data = pdf_dict["fcontent"]

    # ------- Send Email --------
    recipients = ["ed@devoltrans.com", "sanjay@devoltrans.com", "amit@devoltrans.com", "pramod@devoltrans.com", "sudin@devoltrans.com"]
    #recipients = ["sanketvyapari@gmail.com"]
    frappe.sendmail(
        recipients=recipients,
        subject=f"New Order Recieved: {doc.name}",
        message=message,
        attachments=[{
            "fname": f"{doc.name}.pdf",
            "fcontent": pdf_data
        }],
        now=True
    )
