[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Work Order",
  "enabled": 1,
  "modified": "2026-01-15 21:18:06.399873",
  "module": "Addsol Devoltrans Custom",
  "name": "Work Order",
  "script": "frappe.ui.form.on(\"Work Order\", {\n    onload(frm) {\n        // Disable or hide BOM field when docstatus = 0 (Draft)\n        if (frm.doc.docstatus === 0) {\n            frm.set_df_property(\"bom_no\", \"read_only\", 1);\n            // Or to hide entirely:\n            // frm.set_df_property(\"bom_no\", \"hidden\", 1);\n        }\n    },\n    refresh(frm) {\n        // Optionally, if you want to enable BOM later when status changes:\n        if (frm.doc.production_ready) {   // example custom field or status\n            frm.set_df_property(\"bom_no\", \"read_only\", 0);\n            frm.set_df_property(\"bom_no\", \"hidden\", 0);\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2025-12-24 17:01:34.624925",
  "module": "Addsol Devoltrans Custom",
  "name": "Purchaser Order Item File Show",
  "script": "frappe.ui.form.on(\"Purchase Order\", {\n    refresh(frm) {\n        // Avoid duplicate button\n        if (frm.__item_attachments_btn_added) return;\n        frm.__item_attachments_btn_added = true;\n\n        frm.add_custom_button(\n            __(\"Item Attachments\"),\n            () => {\n                show_po_item_attachments(frm);\n            }\n        );\n    }\n});\n\nfunction show_po_item_attachments(frm) {\n    const items = frm.doc.items || [];\n\n    if (!items.length) {\n        frappe.msgprint(\"No items found in this Purchase Order.\");\n        return;\n    }\n\n    // Collect unique item codes\n    const item_codes = [...new Set(items.map(i => i.item_code).filter(Boolean))];\n\n    if (!item_codes.length) {\n        frappe.msgprint(\"No valid items found.\");\n        return;\n    }\n\n    frappe.call({\n        method: \"frappe.client.get_list\",\n        args: {\n            doctype: \"File\",\n            filters: {\n                attached_to_doctype: \"Item\",\n                attached_to_name: [\"in\", item_codes]\n            },\n            fields: [\"file_name\", \"file_url\", \"attached_to_name\"]\n        },\n        callback(r) {\n            if (!r.message || !r.message.length) {\n                frappe.msgprint(\"No attachments found for items in this PO.\");\n                return;\n            }\n\n            // Group files by item\n            const grouped = {};\n            r.message.forEach(f => {\n                grouped[f.attached_to_name] = grouped[f.attached_to_name] || [];\n                grouped[f.attached_to_name].push(f);\n            });\n\n            // Build HTML\n            let html = `<div style=\"max-height:60vh; overflow:auto;\">`;\n\n            item_codes.forEach(item_code => {\n                html += `<h4 style=\"margin-top:12px;\">${item_code}</h4>`;\n\n                if (!grouped[item_code]) {\n                    html += `<p style=\"color:#888;\">No attachments</p>`;\n                    return;\n                }\n\n                html += `<ul style=\"padding-left:18px;\">`;\n                grouped[item_code].forEach(f => {\n                    html += `\n                        <li>\n                            ðŸ“Ž <a href=\"${f.file_url}\" target=\"_blank\">\n                                ${f.file_name}\n                            </a>\n                        </li>\n                    `;\n                });\n                html += `</ul>`;\n            });\n\n            html += `</div>`;\n\n            frappe.msgprint({\n                title: \"Item Attachments\",\n                message: html,\n                wide: true\n            });\n        }\n    });\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "BOM",
  "enabled": 1,
  "modified": "2025-12-29 11:41:28.904980",
  "module": "Addsol Devoltrans Custom",
  "name": "Bom Show Attach",
  "script": "frappe.ui.form.on(\"BOM\", {\n    refresh(frm) {\n        // Avoid duplicate button\n        if (frm.__item_attachments_btn_added) return;\n        frm.__item_attachments_btn_added = true;\n\n        frm.add_custom_button(\n            __(\"Item Attachments\"),\n            () => {\n                show_po_item_attachments(frm);\n            }\n        );\n    }\n});\n\nfunction show_po_item_attachments(frm) {\n    const items = frm.doc.items || [];\n\n    if (!items.length) {\n        frappe.msgprint(\"No items found in this Purchase Order.\");\n        return;\n    }\n\n    // Collect unique item codes\n    const item_codes = [...new Set(items.map(i => i.item_code).filter(Boolean))];\n\n    if (!item_codes.length) {\n        frappe.msgprint(\"No valid items found.\");\n        return;\n    }\n\n    frappe.call({\n        method: \"frappe.client.get_list\",\n        args: {\n            doctype: \"File\",\n            filters: {\n                attached_to_doctype: \"Item\",\n                attached_to_name: [\"in\", item_codes]\n            },\n            fields: [\"file_name\", \"file_url\", \"attached_to_name\"]\n        },\n        callback(r) {\n            if (!r.message || !r.message.length) {\n                frappe.msgprint(\"No attachments found for items in this PO.\");\n                return;\n            }\n\n            // Group files by item\n            const grouped = {};\n            r.message.forEach(f => {\n                grouped[f.attached_to_name] = grouped[f.attached_to_name] || [];\n                grouped[f.attached_to_name].push(f);\n            });\n\n            // Build HTML\n            let html = `<div style=\"max-height:60vh; overflow:auto;\">`;\n\n            item_codes.forEach(item_code => {\n                html += `<h4 style=\"margin-top:12px;\">${item_code}</h4>`;\n\n                if (!grouped[item_code]) {\n                    html += `<p style=\"color:#888;\">No attachments</p>`;\n                    return;\n                }\n\n                html += `<ul style=\"padding-left:18px;\">`;\n                grouped[item_code].forEach(f => {\n                    html += `\n                        <li>\n                            ðŸ“Ž <a href=\"${f.file_url}\" target=\"_blank\">\n                                ${f.file_name}\n                            </a>\n                        </li>\n                    `;\n                });\n                html += `</ul>`;\n            });\n\n            html += `</div>`;\n\n            frappe.msgprint({\n                title: \"Item Attachments\",\n                message: html,\n                wide: true\n            });\n        }\n    });\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Material Request",
  "enabled": 1,
  "modified": "2026-01-20 22:10:04.624255",
  "module": "Addsol Devoltrans Custom",
  "name": "Bom Item In Material Request",
  "script": "frappe.ui.form.on(\"Material Request\", {\n  refresh(frm) {\n    if (frm.doc.material_request_type === \"Purchase\") {\n      frm.add_custom_button(\n        __(\"From BOM (Selective)\"),\n        () => open_bom_dialog(frm),\n        __(\"Get BOM Items\")\n      );\n    }\n  }\n});\n\nfunction open_bom_dialog(frm) {\n  const dialog = new frappe.ui.Dialog({\n    title: \"Select Items from BOM\",\n    size: \"extra-large\",\n    fields: [\n      {\n        fieldtype: \"Link\",\n        fieldname: \"bom\",\n        label: \"BOM\",\n        options: \"BOM\",\n        reqd: 1,\n        onchange() {\n          load_bom_items(dialog, frm);\n        }\n      },\n      {\n        fieldtype: \"Link\",\n        fieldname: \"warehouse\",\n        label: \"Warehouse\",\n        options: \"Warehouse\",\n        reqd: 1,\n        default: frm.doc.set_warehouse || \"\",\n        onchange() {\n          load_bom_items(dialog, frm);\n        }\n      },\n      {\n        fieldtype: \"Table\",\n        fieldname: \"items\",\n        label: \"BOM Items\",\n        cannot_add_rows: true,\n        in_place_edit: false,\n        read_only: 1,\n        fields: [\n  { fieldtype: \"Data\", fieldname: \"item_code\", hidden: 1 },\n  { fieldtype: \"Data\", fieldname: \"uom\", hidden: 1 },\n  { fieldtype: \"Data\", fieldname: \"bom_no\", hidden: 1 },\n  { fieldtype: \"Data\", fieldname: \"project\", hidden: 1 },\n\n  { fieldtype: \"Data\", fieldname: \"item\", label: \"Item\", in_list_view: 1, read_only: 1 },\n  { fieldtype: \"Data\", fieldname: \"requirement\", label: \"Requirement\", in_list_view: 1, read_only: 1 },\n  { fieldtype: \"Float\", fieldname: \"request_qty\", label: \"To Request\", in_list_view: 1 },\n  { fieldtype: \"Data\", fieldname: \"status\", label: \"Status\", in_list_view: 1, read_only: 1  },\n  { fieldtype: \"Data\", fieldname: \"details\", read_only: 1 }\n]\n      }\n    ],\n    primary_action_label: \"Add Items to Material Request\",\n    primary_action(values) {\n      append_items_to_mr(frm, values);\n      dialog.hide();\n    }\n  });\n\n  dialog.show();\n\n\n}\n\nfunction load_bom_items(dialog, frm) {\n  const bom = dialog.get_value(\"bom\");\n  const warehouse = dialog.get_value(\"warehouse\");\n\n  if (!bom || !warehouse) return;\n\n  frappe.call({\n    method: \"addsol_devoltrans_custom.api.bom.get_bom_items_for_mr\",\n    args: {\n      bom: bom,\n      company: frm.doc.company,\n      project: frm.doc.project,\n      warehouse: warehouse,\n      exclude_mr: frm.doc.name\n    },\n    callback(r) {\n      dialog.fields_dict.items.df.data = r.message || [];\n      dialog.fields_dict.items.grid.refresh();\n    }\n  });\n}\n\nfunction append_items_to_mr(frm, dialog) {\n  console.log(frm.doc.items, \"frm.doc.items\")\n  const warehouse = dialog.warehouse;\n  const bom = dialog.bom;\n\n  const rows = dialog.items || [];\n\n  // âœ… keep your original selection logic\n  const selected = rows.filter(\n    row => row.request_qty && row.request_qty > 0 && row.__checked === 1\n  );\n\n  if (!selected.length) {\n    frappe.msgprint(\"Enter Request Qty for at least one item.\");\n    return;\n  }\n\n  // --------------------------------------------------\n  // STEP 1: REMOVE DEFAULT EMPTY ROW (FIRST TIME MR)\n  // --------------------------------------------------\n  if (\n    frm.doc.items &&\n    frm.doc.items.length === 1 &&\n    !frm.doc.items[0].item_code\n  ) {\n    frm.clear_table(\"items\");\n  }\n\n  // --------------------------------------------------\n  // STEP 2: BUILD EXISTING ITEM MAP (AVOID DUPLICATES)\n  // key = item_code + warehouse + bom_no\n  // --------------------------------------------------\n  const existing_map = {};\n\n  (frm.doc.items || []).forEach(row => {\n    if (!row.item_code) return;\n\n    const key = [\n      row.item_code,\n      row.warehouse || \"\",\n      row.bom_no || \"\"\n    ].join(\"||\");\n\n    existing_map[key] = true;\n  });\n\n  // --------------------------------------------------\n  // STEP 3: ADD ONLY NON-DUPLICATE ITEMS\n  // --------------------------------------------------\n  let added = 0;\n  let skipped = 0;\n\n  selected.forEach(row => {\n    const key = [\n      row.item_code,\n      warehouse || \"\",\n      row.bom_no || \"\"\n    ].join(\"||\");\n\n    if (existing_map[key]) {\n      skipped++;\n      return;\n    }\n\n    const child = frm.add_child(\"items\");\n    child.item_code = row.item_code;\n    child.qty = row.request_qty;\n    child.uom = row.uom;\n    child.stock_uom = row.uom;\n    child.bom_no = bom;\n    child.project = row.project;\n    child.warehouse = warehouse;\n    child.schedule_date =\n      frm.doc.schedule_date || frappe.datetime.nowdate();\n\n    existing_map[key] = true;\n    child.conversion_factor = 1;\n    added++;\n  });\n\n  frm.refresh_field(\"items\");\n\n  // --------------------------------------------------\n  // STEP 4: FEEDBACK (OPTIONAL BUT NICE)\n  // --------------------------------------------------\n  if (added && skipped) {\n    frappe.msgprint(\n      `${added} item(s) added. ${skipped} duplicate item(s) skipped.`\n    );\n  } else if (skipped) {\n    frappe.msgprint(\"All selected items already exist in Material Request.\");\n  } else {\n    frappe.msgprint(`${added} item(s) added to Material Request.`);\n  }\n}",
  "view": "Form"
 }
]